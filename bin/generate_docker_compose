#!/usr/bin/env ruby
require 'yaml'

Dir.chdir File.expand_path('../..', __FILE__)

yml = File
  .read(File.join Dir.pwd, 'docker-compose.template.yml')
  .gsub(/ROOTDIR/, Dir.pwd)
template = YAML.load yml
binaries = Dir.glob './dev/*'

template['services'].each do |key, service|
  volumes = service['volumes'] || []
  volumes.select! do |v|
    !v.start_with?('./dev') || binaries.any?(&v.method(:start_with?))
  end
  service.delete('volumes') if volumes == []
end

puts template.to_yaml
